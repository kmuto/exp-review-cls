%\RequirePackage{luatex85}
\documentclass[book,twoside,
  paper=b5,
  fontsize=12Q, jafontsize=12Q, baselineskip=21.6Q
]{jlreq}

% TODO: usepackage定義はいずれ別styファイルへ
\usepackage{luatexja-fontspec}

% luatexドライバを明示しないとmdframedもtcolorboxも座標計算が変になる
\usepackage[dvipdfmx,luatex]{graphicx}%
\usepackage[dvipdfmx,table,luatex]{xcolor}[2007/01/21 v2.11]%requires colortbl, array
\usepackage{tikz}[2015/08/07 v3.0.1a]
\usetikzlibrary{calc}%requires xcolor
\usepackage{multirow}
\usepackage{amsmath}[2013/01/14 v2.14]
\usepackage{amssymb}[2013/01/14 v3.01]
\usepackage{bm}[2014/10/28 v1.1c]
\usepackage{alltt}
\usepackage[luatex,bookmarks=true,bookmarksnumbered=true,hidelinks,setpagesize=false,unicode=true]{hyperref}
% hyperrefのセットアップをどこから定義するか

\usepackage{url}
\usepackage{pxrubrica}
\usepackage{tcolorbox}
\tcbuselibrary{xparse,hooks,skins,breakable}

% TODO: 以下Re:VIEWタグマッチング定義はいずれ別styファイルへ
\makeatletter

% コードリスト囲み
% tcolorboxバージョンで実装
\newenvironment{reviewemlist}{%
  \begin{tcolorbox}[skin=enhanced jigsaw,breakable,colback=black!10,colframe=black!10,boxrule=0mm,arc=0mm]\begin{alltt}}%
 {\end{alltt}\end{tcolorbox}}

\newenvironment{reviewlist}{%
  \begin{tcolorbox}[skin=enhanced jigsaw,breakable,colback=white,colframe=black,boxrule=0.15mm,arc=0mm]\begin{alltt}}%
 {\end{alltt}\end{tcolorbox}}

\newenvironment{reviewsource}{%
  \begin{tcolorbox}[skin=enhanced jigsaw,breakable,colback=white,colframe=black,boxrule=0.15mm,arc=0mm]\begin{alltt}}%
 {\end{alltt}\end{tcolorbox}}

\newenvironment{reviewcmd}{%
  \begin{tcolorbox}[skin=enhanced jigsaw,breakable,colback=black!99,colframe=black!99,boxrule=0mm,arc=0mm]\begin{alltt}\begingroup\color{white}\ignorespaces}%
 {\endgroup\end{alltt}\end{tcolorbox}}

\newcommand{\reviewlistcaption}[1]{{#1}}% TODO
\newcommand{\reviewemlistcaption}[1]{{#1}}% TODO
\newcommand{\reviewsourcecaption}[1]{{#1}}% TODO
\newcommand{\reviewcmdcaption}[1]{{#1}}% TODO
\newenvironment{reviewlistblock}{\par}{\par}

\newcommand{\reviewimageref}[2]{<%= escape_latex(I18n.t("image"))%> #1}
\newcommand{\reviewtableref}[2]{<%= escape_latex(I18n.t("table"))%> #1}
\newcommand{\reviewlistref}[1]{<%= escape_latex(I18n.t("list"))%> #1}
\newcommand{\reviewbibref}[2]{#1}
\newcommand{\reviewcolumnref}[2]{<%= escape_latex(I18n.t("columnname"))%> #1}
\newcommand{\reviewsecref}[2]{#1}

% 図版
\newenvironment{reviewimage}[1][ht]{%
  \begin{figure}[#1]\begin{center}}{\end{center}\end{figure}}

\newenvironment{reviewdummyimage}[1][ht]{%
  \begin{reviewimage}[#1]}{\end{reviewimage}}

\newcommand*{\reviewindepimagecaption[1]}{\caption{#1}} % TODO:採番しない

% 以下はよくわかっていない…(munepiさんコード)
\def\maxwidth{%
  \ifdim\Gin@nat@width>\linewidth
    % \linewidth
    \dimexpr\linewidth - 1\p@ - 3mm\relax
  \else
    % \Gin@nat@width
    \dimexpr\Gin@nat@width - 1\p@ - 3mm\relax
  \fi
}

% 表
\newenvironment{reviewtablesetup}{%
}{}

\newcommand{\reviewth}[1]{\cellcolor{black!70}\textcolor{white}{\bfseries #1}}
\newcommand*\reviewtablecaption[1]{\caption{#1}}
\newenvironment{reviewtable}[1]{%
\begin{reviewtablesetup}\begin{tabular}{#1}}%
{\end{tabular}\end{reviewtablesetup}}

\newcommand*\reviewimgtablecaption[1]{\caption{#1}}

% note等の囲み
\newenvironment{reviewnote}[1][]{%
  \begin{tcolorbox}[skin=enhanced jigsaw,breakable,empty,coltitle=black,title={\sffamily\bfseries NOTE #1},borderline horizontal={0.5mm}{0pt}{black!50}, left=1mm, right=1mm, left skip=6mm]}
 {\end{tcolorbox}}

\newenvironment{reviewmemo}[1][]{%
  \begin{tcolorbox}[skin=enhanced jigsaw,breakable,empty,coltitle=black,title={\sffamily\bfseries MEMO #1},borderline horizontal={0.5mm}{0pt}{black!50}, left=1mm, right=1mm, left skip=6mm]}
 {\end{tcolorbox}}

\newenvironment{reviewtip}[1][]{%
  \begin{tcolorbox}[skin=enhanced jigsaw,breakable,empty,coltitle=black,title={\sffamily\bfseries Tips #1},borderline horizontal={0.5mm}{0pt}{black!50}, left=1mm, right=1mm, left skip=6mm]}
 {\end{tcolorbox}}

\newenvironment{reviewinfo}[1][]{%
  \begin{tcolorbox}[skin=enhanced jigsaw,breakable,empty,coltitle=black,title={\sffamily\bfseries INFORMATION #1},borderline horizontal={0.5mm}{0pt}{black!50}, left=1mm, right=1mm, left skip=6mm]}
 {\end{tcolorbox}}

\newenvironment{reviewwarning}[1][]{%
  \begin{tcolorbox}[skin=enhanced jigsaw,breakable,empty,coltitle=black,title={\sffamily\bfseries WARNING! #1},borderline horizontal={0.5mm}{0pt}{black!50}, left=1mm, right=1mm, left skip=6mm]}
 {\end{tcolorbox}}

\newenvironment{reviewimportant}[1][]{%
  \begin{tcolorbox}[skin=enhanced jigsaw,breakable,empty,coltitle=black,title={\sffamily\bfseries IMPORTANT! #1},borderline horizontal={0.5mm}{0pt}{black!50}, left=1mm, right=1mm, left skip=6mm]}
 {\end{tcolorbox}}

\newenvironment{reviewcaution}[1][]{%
  \begin{tcolorbox}[skin=enhanced jigsaw,breakable,empty,coltitle=black,title={\sffamily\bfseries CAUTION! #1},borderline horizontal={0.5mm}{0pt}{black!50}, left=1mm, right=1mm, left skip=6mm]}
 {\end{tcolorbox}}

\newenvironment{reviewnotice}[1][]{%
  \begin{tcolorbox}[skin=enhanced jigsaw,breakable,empty,coltitle=black,title={\sffamily\bfseries NOTICE #1},borderline horizontal={0.5mm}{0pt}{black!50}, left=1mm, right=1mm, left skip=6mm]}
 {\end{tcolorbox}}

% 書体
\newcommand{\reviewkw}[1]{{\sffamily\bfseries #1}}
\newcommand{\reviewstrong}[1]{{\sffamily\bfseries #1}}
\newcommand{\reviewem}[1]{{\bfseries #1}}
\newcommand{\reviewunderline}[1]{{\underline #1}}% Underlineのほうがよい?
\newcommand{\reviewami}[1]{#1}% TODO

% コラム
\newenvironment{reviewcolumn}[1][COLUMN]{%
  \begin{tcolorbox}[skin=enhanced jigsaw,breakable,boxrule=0.2mm,arc=2mm,colback=white,colframe=black!100!white,title={\sffamily\bfseries #1}]\par}
 {\end{tcolorbox}}

\newcommand{\reviewappendix}[0]{\appendix}

% 基本版面系設定カスタマイズは別styファイルへ
\ModifyPageStyle{headings}{nombre_position={top-fore_edge},running_head_position={top-fore_edge}}
\pagestyle{headings}

\makeatother% @を戻す

% 以下ドキュメントコンテンツ
\begin{document}
\frontmatter
<%= @input_files["PREDEF"] %>

<%- if @config["toc"] -%>
\setcounter{tocdepth}{<%= @config["toclevel"] - 1 %>}
\tableofcontents
<%- end -%>

\mainmatter
<%= @input_files["CHAPS"] %>

\reviewappendix
<%= @input_files["APPENDIX"] %>

<%- if @input_files["POSTDEF"] or @config["colophon"] -%>
\backmatter
<%- end -%>

<%- if @input_files["POSTDEF"] -%>
<%= @input_files["POSTDEF"] %>
<%- end -%>
\end{document}
