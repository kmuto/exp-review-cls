\documentclass[book,twoside,
  paper=b5,
  fontsize=12Q, jafontsize=12Q, baselineskip=21.6Q
]{jlreq}

% TODO: usepackage定義はいずれ別styファイルへ
\usepackage{luatexja-fontspec}

% luatexドライバを明示しないとmdframedの座標計算が変になる
\usepackage[dvipdfmx,luatex]{graphicx}%
\usepackage[dvipdfmx,table,luatex]{xcolor}[2007/01/21 v2.11]%requires colortbl, array
\usepackage{tikz}[2015/08/07 v3.0.1a]
\usetikzlibrary{calc}%requires xcolor
\usepackage[framemethod=TikZ]{mdframed}[2014/05/30 v2.0]%requires expl3 w/ driver=dvipdfmx
\usepackage{multirow}
\usepackage{amsmath}[2013/01/14 v2.14]
\usepackage{amssymb}[2013/01/14 v3.01]
\usepackage{bm}[2014/10/28 v1.1c]
\usepackage{alltt}
\usepackage[luatex,bookmarks=true,bookmarksnumbered=true,hidelinks,setpagesize=false,unicode=true]{hyperref}
% hyperrefのセットアップをどこから定義するか

\usepackage{url}
\usepackage{pxrubrica}

% TODO: 以下Re:VIEWタグマッチング定義はいずれ別styファイルへ
\makeatletter

% コードリスト囲み
\mdfdefinestyle{review@emlist}{%
backgroundcolor=black!10,
innertopmargin=3mm,innerbottommargin=3mm,
innerleftmargin=3mm,innerrightmargin=3mm
}
\newenvironment{review@emlist}{%
 \begin{mdframed}[style=review@emlist]%
  }{\end{mdframed}}%\end{mdframed}

\mdfdefinestyle{review@list}{%
innertopmargin=3mm,innerbottommargin=3mm,
innerleftmargin=3mm,innerrightmargin=3mm,
linewidth=0.15mm
}
\newenvironment{review@list}{%
 \begin{mdframed}[style=review@list]%
  }{\end{mdframed}}%\end{mdframed}

\mdfdefinestyle{review@source}{%
innertopmargin=3mm,innerbottommargin=3mm,
innerleftmargin=3mm,innerrightmargin=3mm,
linewidth=0.15mm
}
\newenvironment{review@source}{%
 \begin{mdframed}[style=review@source]%
  }{\end{mdframed}}%\end{mdframed}

\mdfdefinestyle{review@cmd}{%
innertopmargin=3mm,innerbottommargin=3mm,
innerleftmargin=3mm,innerrightmargin=3mm,
backgroundcolor=black!99,
}
\newenvironment{review@cmd}{%
 \begin{mdframed}[style=review@cmd]%
  }{\end{mdframed}}%\end{mdframed}

% reviewemlist (//emlist)
\newenvironment{reviewemlist}{%
  \begin{review@emlist}\begin{alltt}}%
 {\end{alltt}\end{review@emlist}}

% reviewlist (//list)
\newenvironment{reviewlist}{%
  \begin{review@list}\begin{alltt}}%
 {\end{alltt}\end{review@list}}

% reviewsource (//source)
\newenvironment{reviewsource}{%
  \begin{review@source}\begin{alltt}}%
 {\end{alltt}\end{review@source}}

% reviewsource (//cmd)
% colorの範囲を作るために\begingroup 〜 \endgroupで囲む
\newenvironment{reviewcmd}{%
  \begin{review@cmd}\begin{alltt}\begingroup\color{white}\ignorespaces}%
 {\endgroup\end{alltt}\end{review@cmd}}

\newcommand{\reviewlistcaption}[1]{{#1}}% TODO
\newcommand{\reviewemlistcaption}[1]{{#1}}% TODO
\newcommand{\reviewsourcecaption}[1]{{#1}}% TODO
\newcommand{\reviewcmdcaption}[1]{{#1}}% TODO
\newenvironment{reviewlistblock}{\par}{\par}

% reviewlistblockの定義。しかしこうフロートにしてしまうと、長いリストの分断が厄介になる…
%\newcommand{\reviewlistblockname}{<%= escape_latex(I18n.t("list"))%>}
%\newcounter{reviewlistblock}[chapter]
%\renewcommand{\thereviewlistblock}{%
%  \ifnum\c@chapter>\z@\thechapter.\fi\@arabic\c@reviewlistblock}% 「.」リテラル区切りではなくI18nから引き出したい
%\newenvironment{reviewlistblock}{\@@par% このあたり、munepiさんクラスからの理解がおいついていない
%   \def\caption{%
%     \refstepcounter{reviewlistblock}%
%     \expandafter\@firstofone
%    {\@dblarg{\@caption}}%  dblargというのはカーネルコマンドで、\@dblarg{<command>}{<arg>}が\{<command>}[<arg>]{<arg>}に展開されるのだそうだ。
%   }%
%   \long\def\@caption[##1]##2{%
%     \par
%     \needspace{\baselineskip}%
%     \begingroup
%       \@parboxrestore
%       \normalsize
%       \@makecaption{\reviewlistblockname\thereviewlistblock}{\ignorespaces ##2}\par% 最初の引数は「リスト1.1」を作るところ。kernやskipなどを調整すべきか
%     \endgroup}%
% }{}

\newcommand{\reviewimageref}[2]{<%= escape_latex(I18n.t("image"))%> #1}
\newcommand{\reviewtableref}[2]{<%= escape_latex(I18n.t("table"))%> #1}
\newcommand{\reviewlistref}[1]{<%= escape_latex(I18n.t("list"))%> #1}
\newcommand{\reviewbibref}[2]{#1}
\newcommand{\reviewcolumnref}[2]{<%= escape_latex(I18n.t("columnname"))%> #1}
\newcommand{\reviewsecref}[2]{#1}

% 図版
\newenvironment{reviewimage}[1][ht]{%
  \begin{figure}[#1]\begin{center}}{\end{center}\end{figure}}

\newenvironment{reviewdummyimage}[1][ht]{%
  \begin{reviewimage}[#1]}{\end{reviewimage}}

\newcommand*{\reviewindepimagecaption[1]}{\caption{#1}} % TODO:採番しない

% 以下はよくわかっていない…(munepiさんコード)
\def\maxwidth{%
  \ifdim\Gin@nat@width>\linewidth
    % \linewidth
    \dimexpr\linewidth - 1\p@ - 3mm\relax
  \else
    % \Gin@nat@width
    \dimexpr\Gin@nat@width - 1\p@ - 3mm\relax
  \fi
}

% 表
\newenvironment{reviewtablesetup}{%
}{}

\newcommand{\reviewth}[1]{\cellcolor{black!70}\textcolor{white}{\bfseries #1}}
\newcommand*\reviewtablecaption[1]{\caption{#1}}
\newenvironment{reviewtable}[1]{%
\begin{reviewtablesetup}\begin{tabular}{#1}}%
{\end{tabular}\end{reviewtablesetup}}

\newcommand*\reviewimgtablecaption[1]{\caption{#1}}

% note等の囲み
\mdfdefinestyle{review@note}{%
innertopmargin=3mm,innerbottommargin=3mm,
innerleftmargin=3mm,innerrightmargin=3mm,
roundcorner=2mm,
frametitlefont={\sffamily\bfseries\color{white}},
frametitlerule=true,
frametitlebackgroundcolor=black,
} % frametitleの文字列はi18n化させたい
\newenvironment{review@note}[1]{%
 \begin{mdframed}[style=review@note,frametitle={NOTE #1}]%
  }{\end{mdframed}}%\end{mdframed}

\newenvironment{reviewnote}[1]{%
  \begin{review@note}[#1]}% なんかこのへんどこか単純に間違ってる… reviewnoteの1つめの引数をframetitleに渡したい、ということ
 {\end{review@note}}

% 書体
\newcommand{\reviewkw}[1]{{\sffamily\bfseries #1}}
\newcommand{\reviewstrong}[1]{{\sffamily\bfseries #1}}
\newcommand{\reviewem}[1]{{\bfseries #1}}
\newcommand{\reviewunderline}[1]{{\underline #1}}% Underlineのほうがよい?
\newcommand{\reviewami}[1]{#1}% TODO

% 基本版面系設定カスタマイズは別styファイルへ
\ModifyPageStyle{headings}{nombre_position={top-fore_edge},running_head_position={top-fore_edge}}
\pagestyle{headings}

\makeatother% @を戻す

% 以下ドキュメントコンテンツ
\begin{document}
\frontmatter
<%= @input_files["PREDEF"] %>

<%- if @config["toc"] -%>
\setcounter{tocdepth}{<%= @config["toclevel"] - 1 %>}
\tableofcontents
<%- end -%>

\mainmatter
<%= @input_files["CHAPS"] %>

%\reviewappendix
<%= @input_files["APPENDIX"] %>

<%- if @input_files["POSTDEF"] or @config["colophon"] -%>
\backmatter
<%- end -%>

<%- if @input_files["POSTDEF"] -%>
<%= @input_files["POSTDEF"] %>
<%- end -%>
\end{document}
